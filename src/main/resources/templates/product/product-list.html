<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{layout/header :: head('Sản phẩm')}"></th:block>
</head>
<body>
<th:block th:replace="~{layout/header :: navbar}"></th:block>

<div class="container my-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">Trang chủ</a></li>
            <li class="breadcrumb-item active">Sản phẩm</li>
        </ol>
    </nav>

    <div class="row">
        <!-- SIDEBAR CATEGORIES (DYNAMIC) -->
        <div class="col-lg-3">
            <div class="list-group mb-4">
                <!-- Nếu không dùng GlobalModelAdvice thì đổi navCategories -> categories -->
                <a th:each="c : ${navCategories}"
                   class="list-group-item list-group-item-action"
                   th:href="@{/product/list-by-category/{id}(id=${c.id})}"
                   th:text="${c.name}"
                   th:classappend="${currentCategory} == ${c.id} ? ' active' : ''">
                </a>

                <div th:if="${#lists.isEmpty(navCategories)}" class="text-muted p-2">
                    Chưa có danh mục
                </div>
            </div>
        </div>

        <!-- PRODUCTS GRID -->
        <div class="col-lg-9">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Danh sách sản phẩm</h4>
                <span class="text-muted" th:if="${products != null}"
                      th:text="${products.totalElements + ' sản phẩm'}">0 sản phẩm</span>
            </div>

            <div th:if="${products == null or products.totalElements == 0}" class="alert alert-info">
                Không tìm thấy sản phẩm nào.
            </div>

            <div class="row g-4" th:if="${products != null and products.totalElements > 0}">
                <!-- ✅ LẶP TRÊN products.content -->
                <div class="col-6 col-md-4" th:each="p : ${products.content}">
                    <div class="card h-100">
                        <img th:src="@{${p.image}}" class="card-img-top" style="height:220px;object-fit:cover"
                             onerror="this.src='https://via.placeholder.com/300x220?text=No+Image'">
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title text-truncate" th:text="${p.name}">Product</h6>
                            <p class="text-muted small" th:text="${p.category.name}">Category</p>
                            <h5 class="text-danger"
                                th:text="${#numbers.formatDecimal(p.price,0,'COMMA',0,'POINT')} + ' ₫'">0 ₫</h5>
                            <div class="mt-auto d-grid gap-2">
                                <a th:href="@{/product/detail/{id}(id=${p.id})}" class="btn btn-sm btn-outline-primary">Chi tiết</a>
                                <form th:action="@{/cart/add/{productId}(productId=${p.id})}" method="post">
                                    <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">
                                    <button class="btn btn-sm btn-primary w-100">Thêm giỏ</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGINATION -->
            <nav class="mt-4" th:if="${products != null and products.totalPages > 1}">
                <ul class="pagination justify-content-center">
                    <li class="page-item" th:classappend="${products.first} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/product/list-by-category/{id}(id=${currentCategory}, page=${products.number-1}, size=${products.size})}">&laquo;</a>
                    </li>
                    <li class="page-item" th:each="i : ${#numbers.sequence(0, products.totalPages-1)}"
                        th:classappend="${i == products.number} ? ' active'">
                        <a class="page-link"
                           th:href="@{/product/list-by-category/{id}(id=${currentCategory}, page=${i}, size=${products.size})}"
                           th:text="${i+1}">1</a>
                    </li>
                    <li class="page-item" th:classappend="${products.last} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/product/list-by-category/{id}(id=${currentCategory}, page=${products.number+1}, size=${products.size})}">&raquo;</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<th:block th:replace="~{layout/footer :: footer}"></th:block>
<th:block th:replace="~{layout/footer :: scripts}"></th:block>
</body>
</html>
