<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{layout/header :: head('Quản lý sản phẩm')}"></th:block>
</head>
<body>
<th:block th:replace="~{layout/header :: navbar}"></th:block>

<div class="container-fluid my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="fas fa-box"></i> Quản lý sản phẩm</h4>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal">+ Thêm sản phẩm</button>
    </div>

    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                <tr>
                    <th>ID</th><th>Ảnh</th><th>Tên</th><th>Danh mục</th>
                    <th class="text-end">Giá</th><th class="text-center">SL</th>
                    <th class="text-center">TT</th><th class="text-center">Thao tác</th>
                </tr>
                </thead>
                <tbody>
                <!-- ✅ iterate Page.content -->
                <tr th:each="p : ${products.content}">
                    <td th:text="${p.id}">1</td>
                    <td>
                        <img th:src="@{${p.image}}"
                             style="width:50px;height:50px;object-fit:cover"
                             class="rounded"
                             onerror="this.src='https://via.placeholder.com/50'">
                    </td>
                    <td th:text="${p.name}">Name</td>
                    <td><span class="badge bg-secondary" th:text="${p.category?.name}">Cat</span></td>
                    <td class="text-end" th:text="${#numbers.formatDecimal(p.price,0,'COMMA',0,'POINT')} + ' ₫'">0</td>
                    <td class="text-center" th:text="${p.quantity}">0</td>
                    <td class="text-center">
                        <span class="badge bg-success" th:if="${p.available}">Hoạt động</span>
                        <span class="badge bg-danger"  th:unless="${p.available}">Tạm dừng</span>
                    </td>
                    <td class="text-center">
                        <!-- ✅ đúng base /admin/products -->
                        <a class="btn btn-sm btn-outline-primary"
                           th:href="@{/admin/products/edit/{id}(id=${p.id})}">Sửa</a>

                        <!-- ✅ delete POST + CSRF -->
                        <form th:action="@{/admin/products/delete/{id}(id=${p.id})}"
                              method="post" class="d-inline">
                            <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">
                            <button class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('Xóa sản phẩm này?')">Xóa</button>
                        </form>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(products.content)}">
                    <td colspan="8" class="text-center text-muted py-4">Chưa có sản phẩm</td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- ✅ phân trang cơ bản -->
        <div class="card-footer d-flex justify-content-between align-items-center">
            <div>
                Trang <span th:text="${products.number + 1}"></span> / <span th:text="${products.totalPages}"></span>
                — Tổng: <span th:text="${products.totalElements}"></span>
            </div>
            <div class="btn-group">
                <a class="btn btn-outline-secondary"
                   th:classappend="${products.first} ? ' disabled'"
                   th:href="@{/admin/products(page=${products.number - 1}, size=${products.size})}">‹ Trước</a>
                <a class="btn btn-outline-secondary"
                   th:classappend="${products.last} ? ' disabled'"
                   th:href="@{/admin/products(page=${products.number + 1}, size=${products.size})}">Sau ›</a>
            </div>
        </div>
    </div>
</div>

<!-- ✅ Modal: dùng th:object để bind thẳng Product + category.id -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content"
              th:action="@{/admin/products/save}"
              method="post" enctype="multipart/form-data"
              th:object="${product}">
            <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">
            <div class="modal-header">
                <h5 class="modal-title" th:text="${mode=='edit' ? 'Sửa sản phẩm' : 'Thêm sản phẩm'}">Thêm/Sửa sản phẩm</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- id để update -->
                <input type="hidden" th:field="*{id}">

                <div class="mb-3">
                    <label class="form-label">Tên</label>
                    <input class="form-control" th:field="*{name}" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Danh mục</label>
                    <!-- ✅ bind nested: category.id -->
                    <select class="form-select" th:field="*{category.id}" required>
                        <option value="">--Chọn--</option>
                        <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}">Cat</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Giá</label>
                    <input type="number" class="form-control" th:field="*{price}" min="0" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Số lượng</label>
                    <input type="number" class="form-control" th:field="*{quantity}" min="0" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Hình ảnh</label>
                    <input type="file" class="form-control" name="imageFile" accept="image/*">
                    <small class="text-muted d-block mt-1">Ảnh hiện tại: <span th:text="*{image}">/images/..</span></small>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" th:field="*{available}" id="available">
                    <label class="form-check-label" for="available">Hoạt động</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button class="btn btn-primary">Lưu</button>
            </div>
        </form>
    </div>
</div>

<th:block th:replace="~{layout/footer :: footer}"></th:block>
<th:block th:replace="~{layout/footer :: scripts}"></th:block>

<!-- Nếu đang ở chế độ edit, tự mở modal -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const mode = /*[[${mode}]]*/ 'create';
    if (mode === 'edit') {
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
    }
    /*]]>*/
</script>
</body>
</html>
